<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Boodschappenbudgetter</title>
  <style>
    :root{
      --bg: #0b0c10;
      --panel:#111317;
      --panel-2:#151922;
      --muted:#9aa3af;
      --text:#f5f7ff;
      --accent:#0a84ff; /* iOS system blue */
      --accent-2:#30d158; /* iOS system green */
      --danger:#ff453a;  /* iOS system red */
      --border:#1e2430;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:20px;
      --radius-sm:14px;
      --inset-sep: rgba(255,255,255,0.06);
      --font-scale: 1; /* Dynamic Type scale */
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f2f3f7;
        --panel:#ffffff;
        --panel-2:#f7f8fb;
        --muted:#6b7280;
        --text:#0b0c10;
        --accent:#007aff;
        --accent-2:#34c759;
        --danger:#ff3b30;
        --border:#e6e8ee;
        --shadow: 0 8px 24px rgba(0,0,0,.08);
        --inset-sep: rgba(0,0,0,0.06);
      }
    }
    /* Manual theme override via [data-theme] */
    html[data-theme="light"]{
    --bg:#f2f3f7; --panel:#ffffff; --panel-2:#f7f8fb; --muted:#6b7280; --text:#0b0c10;
    --accent:#007aff; --accent-2:#34c759; --danger:#ff3b30; --border:#e6e8ee;
    --shadow: 0 8px 24px rgba(0,0,0,.08); --inset-sep: rgba(0,0,0,0.06);
    }
    html[data-theme="dark"]{
    --bg: #0b0c10; --panel:#111317; --panel-2:#151922; --muted:#9aa3af; --text:#f5f7ff;
    --accent:#0a84ff; --accent-2:#30d158; --danger:#ff453a; --border:#1e2430;
    --shadow: 0 10px 30px rgba(0,0,0,.35); --inset-sep: rgba(255,255,255,0.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{ font-size: calc(16px * var(--font-scale)); }
    body{
      margin:0; background: radial-gradient(1200px 600px at 20% -10%, rgba(10,132,255,0.06), transparent 55%),
                               radial-gradient(1000px 600px at 120% 10%, rgba(52,199,89,0.05), transparent 55%),
                               linear-gradient(180deg, var(--panel-2), var(--bg));
      color:var(--text); font:16px/1.5 -apple-system, BlinkMacSystemFont, "SF Pro Text", Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, system-ui;
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }
    header{
      position:sticky; top:0; z-index:10;
      background:color-mix(in oklab, var(--panel-2) 80%, transparent);
      -webkit-backdrop-filter: saturate(180%) blur(16px);
      backdrop-filter: saturate(180%) blur(16px);
      border-bottom:1px solid var(--border);
    }
    .bar{
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 18px; gap:12px;
    }
    .title{font-weight:800; letter-spacing:.2px; font-size:18px}
    .chip{
      background:linear-gradient(180deg, color-mix(in oklab, var(--panel) 80%, transparent), var(--panel-2));
      border:1px solid var(--border);
      color:var(--text);
      padding:0 16px;            /* horizontal padding only */
      border-radius:999px;
      font-size:13px;
      box-shadow:0 1px 0 var(--inset-sep) inset;
      display:inline-block;      /* use inline-block for line-height centering */
      text-align:center;
      white-space:nowrap;
      height:36px;               /* fixed height */
      line-height:36px;          /* exact vertical centering */
      -webkit-appearance:none;
      appearance:none;
    }
    .container{padding:12px; padding-bottom:140px; max-width:820px; margin:0 auto;}
    .card{
      background:linear-gradient(180deg, color-mix(in oklab, var(--panel) 90%, transparent), var(--panel-2));
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
    }
    .toolbar{
      display:flex; gap:8px; overflow:auto; padding:10px; align-items:center;
    }
    .seg{display:flex; background:color-mix(in oklab, var(--panel) 70%, transparent); border:1px solid var(--border); border-radius:999px; padding:2px; gap:4px}
    .seg button{border:0; background:transparent; color:var(--muted); padding:0 14px; height:32px; line-height:32px; border-radius:999px; font-weight:700; font-size:13px}
    .seg button.active{background:var(--accent); color:#fff; box-shadow:0 6px 12px rgba(10,132,255,.3)}
    .store-filter{display:flex; gap:8px; padding:6px 10px; flex-wrap:nowrap; overflow:auto}
    .store-pill{border:1px solid var(--border); background:var(--panel); color:var(--text); border-radius:999px; padding:8px 12px; font-size:13px; white-space:nowrap}
    .store-pill.active{background:color-mix(in oklab, var(--accent) 12%, var(--panel)); border-color:color-mix(in oklab, var(--accent) 35%, var(--border))}
    /* Settings: make store list wrap and avoid horizontal scroll */
    #storeList.store-filter{ flex-wrap: wrap; overflow: visible; padding-left: 0; padding-right: 0; }
    #storeList .store-pill{ margin-bottom:8px; }
    .list{padding:8px}
    .item{display:grid; grid-template-columns: 28px 1fr auto; gap:12px; align-items:center; padding:16px 14px; border-bottom:1px solid var(--inset-sep)}
    .item:last-child{border-bottom:0}
    .ck{appearance:none; width:22px;height:22px;border-radius:7px;border:2px solid color-mix(in oklab, var(--accent) 25%, var(--border)); display:inline-grid; place-items:center; cursor:pointer; background:var(--panel)}
    .ck:checked{background:var(--accent); border-color:var(--accent)}
    .name{font-weight:600}
    .meta{color:var(--muted); font-size:12px; margin-top:2px}
    .price{font-weight:700}
    .row-actions{display:flex; gap:8px}
    .iconbtn{width:36px;height:36px; border-radius:999px; border:1px solid var(--border); background:var(--panel); display:grid; place-items:center; cursor:pointer; box-shadow:0 1px 0 var(--inset-sep) inset}
    .iconbtn:hover{background:color-mix(in oklab, var(--panel) 80%, var(--accent) 6%)}
    .iconbtn.danger:hover{background:color-mix(in oklab, var(--panel) 80%, var(--danger) 10%); border-color:color-mix(in oklab, var(--danger) 40%, var(--border))}
    .icon{font-style:normal}
    .empty{padding:24px; text-align:center; color:var(--muted)}

    .totals{position:fixed; left:0; right:0; bottom:0; z-index:20; background:color-mix(in oklab, var(--panel-2) 88%, transparent); -webkit-backdrop-filter: saturate(180%) blur(16px); backdrop-filter: saturate(180%) blur(16px); border-top:1px solid var(--border)}
    .totals .wrap{max-width:820px; margin:0 auto; padding:12px; display:grid; grid-template-areas:"kpis" "actions"; grid-template-columns:1fr; gap:12px; align-items:center}
    @media (min-width:560px){
      .totals .wrap{grid-template-areas:"kpis actions"; grid-template-columns:1fr auto}
    }
    .kpis{grid-area:kpis; display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:10px}
    .actions{grid-area:actions; display:flex; gap:10px; justify-content:flex-end}
    @media (max-width:559px){ .actions .btn{width:100%} }
    .kpi{
      background:
        linear-gradient(180deg, color-mix(in oklab, #fff 6%, var(--panel)) 0%, color-mix(in oklab, var(--panel-2) 70%, transparent) 100%);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px 16px;
      box-shadow: 0 1px 0 var(--inset-sep) inset, 0 8px 24px rgba(0,0,0,.12);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .kpi:hover{transform: translateY(-1px); box-shadow: 0 1px 0 var(--inset-sep) inset, 0 14px 34px rgba(0,0,0,.16)}
    .kpi .label{font-size:13px; color:var(--muted); margin-bottom:6px}
    .kpi .val{font-weight:900; font-size:clamp(20px, 4.6vw, 28px); letter-spacing:-0.2px}
    @media (max-width:380px){
      .kpi{padding:12px}
      .kpi .val{font-size:18px}
      .kpi .label{font-size:12px}
    }
    .btn{border:1px solid var(--border); background:var(--panel); color:var(--text); padding:12px 16px; border-radius:14px; font-weight:700; transition:transform .06s ease, box-shadow .12s ease; box-shadow:0 1px 0 var(--inset-sep) inset, 0 6px 16px rgba(0,0,0,.10); transform-origin:center;}
    .btn:active{transform:translateY(1px)}
    .btn:focus-visible{outline:2px solid color-mix(in oklab, var(--accent) 60%, #fff); outline-offset:2px; border-color:color-mix(in oklab, var(--accent) 40%, var(--border))}
    .btn.accent{border-color:color-mix(in oklab, var(--accent) 55%, var(--border)); background:linear-gradient(180deg, color-mix(in oklab, var(--accent) 92%, #fff 0%) 0%, color-mix(in oklab, var(--accent) 78%, #000 0%) 100%); color:#fff; box-shadow:0 8px 22px rgba(10,132,255,.28)}

    /* Haptics-like micro press */
    .pressable{ transition: transform .06s ease, box-shadow .12s ease; transform-origin:center; }
    .pressable.is-pressing{ transform: translateY(1px) scale(.985); box-shadow:0 2px 10px rgba(0,0,0,.12); }

    /* Segmented press */
    .seg button.pressable.is-pressing{ transform: translateY(1px) scale(.985); }

    .adder{
      position:sticky; bottom:120px; z-index:5; padding:8px;
    }
    .adder .card{padding:10px}
    form.add{
      display:grid; grid-template-columns: 1fr 92px 110px; gap:8px; align-items:end;
    }
    .field{
      display:flex; flex-direction:column; gap:6px;
    }
    label{font-size:12px; color:#9aa5bf}
    input, select{width:100%; border-radius:14px; border:1px solid var(--border); background:var(--panel); color:var(--text); padding:12px 14px; font-size:16px; box-shadow:0 1px 0 var(--inset-sep) inset}
    .row2{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-top:8px}
    /* Settings: make the new store name input take all remaining space and keep button on one line */
    #settingsDlg .field .row2{ grid-template-columns: 1fr max-content; }
    #newStoreName{ min-width: 0; width: 100%; }
    #addStoreBtn{ white-space: nowrap; }
    @media (max-width: 380px){
      #settingsDlg .field .row2{ grid-template-columns: 1fr; }
      #addStoreBtn{ width:100%; }
    }
    .row3{display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:8px}
    .switch{display:flex; align-items:center; gap:10px}
    .switch input{width:48px; height:28px; border-radius:999px; appearance:none; position:relative; background:color-mix(in oklab, var(--panel) 70%, transparent); border:1px solid var(--border); transition:.2s}
    .switch input:checked{background:color-mix(in oklab, var(--accent) 40%, var(--panel))}
    .switch input::after{content:""; position:absolute; top:3px; left:3px; width:22px; height:22px; border-radius:50%; background:#fff; transition:.2s; box-shadow:0 1px 3px rgba(0,0,0,.25)}
    .switch input:checked::after{transform:translateX(20px)}
    .hint{font-size:12px; color:#94a3b8}

    dialog{width:min(640px, 92vw); border:1px solid var(--border); border-radius:18px; padding:0; background:linear-gradient(180deg, var(--panel), var(--panel-2)); color:var(--text); box-shadow:var(--shadow); -webkit-backdrop-filter: saturate(180%) blur(16px); backdrop-filter: saturate(180%) blur(16px); display:flex; flex-direction:column}
    /* Hide dialogs when not opened (fallback for browsers without <dialog> support) */
    dialog:not([open]){ display:none; }
    /* Settings: full-width reset button row */
    #settingsDlg .row3{ grid-template-columns: 1fr; }
    #resetStoresBtn{ width:100%; }
    dialog::backdrop{background:rgba(0,0,0,.35)}
    .dlg-head{padding:16px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between}
    .dlg-body{padding:16px; display:grid; gap:12px; position:relative; overflow:auto; flex:1 1 auto; min-height:0; max-height:min(70vh, calc(100vh - 200px));}
    .dlg-actions{padding:12px 16px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap}

    /* Scroll cue inside settings body */
    .dlg-body::after{ /* bottom fade */
      content:""; position:sticky; bottom:0; left:0; right:0; height:28px; pointer-events:none;
      background:linear-gradient(to bottom, rgba(0,0,0,0), color-mix(in oklab, var(--panel-2) 92%, transparent));
      opacity:0; transition:opacity .2s;
    }
    .dlg-body::before{ /* down chevron */
      content:"âŒ„"; position:sticky; bottom:6px; left:0; right:0; text-align:center; pointer-events:none;
      font-size:18px; color:var(--muted); opacity:0; transition:opacity .2s, transform .3s ease; transform: translateY(0);
    }
    .dlg-body.can-scroll.at-top::after,
    .dlg-body.can-scroll.at-top::before{ opacity:1; }
    .dlg-body.at-bottom::after,
    .dlg-body.at-bottom::before{ opacity:0; }

    /* Settings dialog: make action buttons fit on small screens */
    #settingsDlg .dlg-actions .btn{ padding:10px 12px; font-size:0.95rem; }
    @media (max-width: 560px){
      #settingsDlg .dlg-actions{ justify-content:stretch; }
      #settingsDlg .dlg-actions .btn{ flex:1 1 calc(50% - 10px); min-width:0; }
      #settingsDlg .dlg-actions .btn.accent{ order: 99; } /* keep Bewaren on the last row/right */
    }

    .hr{height:1px; background:#22304d; margin:8px 0}
    .note{font-size:12px; color:#9aa5bf}
    .tag{
      font-size:13px;
      color:#fff;
      background:var(--accent);
      border:1px solid color-mix(in oklab, var(--accent) 60%, var(--border));
      border-radius:999px;
      display:inline-flex;
      align-items:center;          /* vertical centering */
      justify-content:center;      /* horizontal centering */
      height:32px;                 /* fixed height for optical centering */
      padding:0 12px;              /* horizontal padding only */
      line-height:1;               /* remove font metric bias */
      -webkit-appearance:none;
      appearance:none;
    }

    @media (min-width:560px){
      form.add{grid-template-columns: 1.3fr 0.9fr 1fr 120px}
      .row2{grid-template-columns: 1fr 1fr 1fr 1fr}
      .adder{bottom:132px}
    }

    /* When price field is hidden, reflow grid */
    form.add.no-price{ grid-template-columns: 1fr 92px 1fr; }
    @media (min-width:560px){
    form.add.no-price{ grid-template-columns: 1.3fr 0.9fr 120px }
    }
  </style>

    <!-- Favicon -->    
  <!-- App icons / favicons -->
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="192x192" href="./android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="./android-chrome-512x512.png">
  <meta name="theme-color" content="#0a84ff">
     
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">ðŸ›’ BOCHP.</div>
      <button class="chip" id="openSettings">Instellingen</button>
    </div>
  </header>

  <main class="container">
    <!-- Top toolbar -->
    <div class="toolbar">
      <div class="seg" id="viewSeg">
        <button data-view="all" class="active pressable">Alle</button>
        <button data-view="store" class="pressable">Per winkel</button>
      </div>
      <span class="tag" id="monthTag"></span>
    </div>

    <!-- Store filters (shown in 'store' view) -->
    <div class="store-filter" id="storeFilter" style="display:none"></div>

    <!-- Items list -->
    <div class="card list" id="list"></div>

    <!-- Add form -->
    <div class="adder">
      <div class="card">
        <form class="add" id="addForm">
          <div class="field">
            <label for="name">Boodschap</label>
            <input id="name" placeholder="vb. Appels" required />
          </div>
          <div class="field">
            <label for="qty">Aantal</label>
            <input id="qty" type="number" inputmode="decimal" min="0" step="0.01" value="1" required />
          </div>
          <div class="field" id="priceField">
            <label for="price">Prijs/stuk (â‚¬)</label>
            <input id="price" type="number" inputmode="decimal" min="0" step="0.01" placeholder="0.00" required />
          </div>
          <div class="field">
            <label for="store">Winkel</label>
            <select id="store"></select>
          </div>
          <button class="btn accent" style="margin-top:22px" type="submit">Toevoegen</button>
        </form>
        <div class="row3">
          <div class="switch">
            <input id="recurring" type="checkbox" />
            <label for="recurring">Terugkeerbaar</label>
          </div>
          <div class="hint">Terugkeerbaar blijft staan bij <b>Maand wissen</b>.</div>
        </div>
      </div>
    </div>
  </main>

  <!-- Sticky totals -->
  <div class="totals">
    <div class="wrap">
      <div class="kpis">
        <div class="kpi">
          <div class="label">Totaal (zicht)</div>
          <div class="val" id="totalVisible">â‚¬ 0,00</div>
        </div>
        <div class="kpi">
          <div class="label">Totaal (alle winkels)</div>
          <div class="val" id="totalAll">â‚¬ 0,00</div>
        </div>
        <div class="kpi">
          <div class="label">Totaal deze maand</div>
          <div class="val" id="monthTotalEl">â‚¬ 0,00</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn accent pressable" id="nextWeekBtn" title="Sluit week en tel op">Volgende week</button>
        <button class="btn accent pressable" id="nextMonthBtn" title="Sluit maand en reset">Volgende maand</button>
      </div>
    </div>
  </div>

  <!-- Settings dialog -->
  <dialog id="settingsDlg">
    <div class="dlg-head">
      <div style="font-weight:800">Instellingen</div>
      <button class="iconbtn" id="closeSettings" aria-label="Sluiten"><span class="icon">âœ–</span></button>
    </div>
    <div class="dlg-body">
      <div class="field">
        <label for="currency">Valuta (weergave)</label>
        <select id="currency">
          <option value="EUR" selected>EUR (â‚¬)</option>
          <option value="USD">USD ($)</option>
          <option value="GBP">GBP (Â£)</option>
        </select>
      </div>
      <div class="field">
        <label for="themeSel">Weergave</label>
        <select id="themeSel">
          <option value="system">Systeem (auto)</option>
          <option value="light">Licht</option>
          <option value="dark">Donker</option>
        </select>
        <div class="hint">Kies â€˜Systeemâ€™ om automatisch met je iOS/macOS thema mee te gaan.</div>
      </div>
      <div class="field">
        <label for="fontScale">Tekstgrootte</label>
        <select id="fontScale">
          <option value="0.90">Kleiner</option>
          <option value="1">Standaard</option>
          <option value="1.12">Groter</option>
          <option value="1.25">Extra groot</option>
          <option value="1.35">Zeer groot</option>
        </select>
        <div class="hint">Past de typografie aan zoals Dynamic Type.</div>
      </div>
      <div class="field">
        <label for="togglePriceField">Prijsveld</label>
        <div class="switch">
            <input id="togglePriceField" type="checkbox" />
            <label for="togglePriceField">Toon prijsveld bij toevoegen</label>
        </div>
        <div class="hint">Als uit, voeg je items toe zonder prijs. (Totaal blijft â‚¬0 totdat je prijzen invult.)</div>
      </div>
      <div class="field">
        <label>Winkels beheren</label>
        <div class="row2">
          <input id="newStoreName" placeholder="Nieuwe winkelnaam" />
          <button class="btn" id="addStoreBtn" type="button">Winkel toevoegen</button>
        </div>
        <div id="storeList" class="store-filter" style="padding-left:0; padding-right:0; margin-top:6px"></div>
        <div class="hint">Tip: Verwijder een winkel met het prullenmandje. "Algemeen" kan niet verwijderd worden.</div>
        <div class="row3" style="margin-top:8px">
          <button class="btn" id="resetStoresBtn" type="button">Herstel standaard winkels</button>
        </div>
      </div>
      <div class="note">Instellingen worden lokaal opgeslagen op dit toestel (localStorage).</div>
      <div class="hr"></div>
      <div class="note">Tip: gebruik de weergave <b>Per winkel</b> om snel subtotals te zien en gericht te shoppen.</div>
    </div>
    <div class="dlg-actions">
      <button class="btn danger pressable" id="purgeAllBtn" title="Verwijder alle data (incl. localStorage)">Alle data verwijderen</button>
      <button class="btn danger pressable" id="clearMonthBtn" title="Wist deze maand">Maand wissen</button>
      <button class="btn pressable" id="resetAll">Alles resetten</button>
      <button class="btn accent pressable" id="saveSettings">Bewaren</button>
    </div>
  </dialog>

  <script>
    // -------- Utilities
    const $ = sel => document.querySelector(sel);
    const fmt = (n, c=state.settings.currency) => {
      try{
        return new Intl.NumberFormat('nl-BE',{style:'currency',currency:c}).format(n || 0);
      }catch(_){ return `â‚¬ ${Number(n||0).toFixed(2)}` }
    };
    const uid = () => Math.random().toString(36).slice(2,9);
    const monthKey = (d=new Date()) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;

    const DEFAULT_STORES = ['Algemeen','Colruyt','Delhaize','ALDI','Lidl','Carrefour','Action','Kruidvat','Andere'];

    // -------- State & Storage
    const LS_KEY = 'bb2_state_v1';
    const defaultState = () => ({
      items: [],
      month: monthKey(),
      monthTotal: 0,
      settings: { currency: 'EUR', theme: 'system', fontScale: 1, stores: DEFAULT_STORES.slice(), showPrice: true },
    });

    function applyPriceVisibility(){
        const show = state.settings.showPrice !== false; // default: tonen
        const field = document.getElementById('priceField');
        const input = document.getElementById('price');
        const form  = document.getElementById('addForm');
        if(field && input && form){
            field.style.display = show ? '' : 'none';
            input.required = !!show;
            form.classList.toggle('no-price', !show);
        }
    }

    let state = load() || defaultState();
    // Migration: ensure stores array always present and valid
    if(!state.settings) state.settings = {};
    if(!Array.isArray(state.settings.stores) || state.settings.stores.length === 0){
      state.settings.stores = DEFAULT_STORES.slice();
      save();
    }
    ensureMonth();
    // -------- Store manager add/remove listeners

    function applyTheme(){
      const t = (state.settings.theme||'system');
      const html = document.documentElement;
      if(t==='light' || t==='dark'){
        html.setAttribute('data-theme', t);
      }else{
        html.removeAttribute('data-theme'); // volgt prefers-color-scheme
      }
    }
    function applyFontScale(){
      const s = Number(state.settings.fontScale||1) || 1;
      document.documentElement.style.setProperty('--font-scale', String(s));
    }

    function updateScrollCue(){
      const body = document.querySelector('#settingsDlg .dlg-body');
      if(!body) return;
      const {scrollTop, scrollHeight, clientHeight} = body;
      const can = scrollHeight > clientHeight + 1;
      body.classList.toggle('can-scroll', can);
      body.classList.toggle('at-top', scrollTop <= 0);
      body.classList.toggle('at-bottom', scrollTop + clientHeight >= scrollHeight - 1);
    }

    function enablePressEffects(selector){
      document.addEventListener('pointerdown', (e)=>{
        const el = e.target.closest(selector);
        if(!el) return;
        el.classList.add('is-pressing');
      });
      const clear = ()=>{
        document.querySelectorAll(selector+'.is-pressing').forEach(el=>el.classList.remove('is-pressing'));
      };
      document.addEventListener('pointerup', clear);
      document.addEventListener('pointercancel', clear);
      document.addEventListener('pointerleave', (e)=>{
        const el = e.target.closest(selector);
        if(el) el.classList.remove('is-pressing');
      });
    }

    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
    function load(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY)); }catch(_){ return null; }
    }
    function ensureMonth(){
      const now = monthKey();
      if(state.month !== now){
        // Nieuwe maand: reset accumulator en verwijder niet-terugkeerbare items
        state.items = state.items.filter(it => it.recurring);
        state.monthTotal = 0;
        state.month = now;
        save();
      }
      $('#monthTag').textContent = `Maand: ${state.month}`;
    }

    // -------- Rendering
    const listEl = $('#list');
    const storeFilterEl = $('#storeFilter');
    const totalVisibleEl = $('#totalVisible');
    const totalAllEl = $('#totalAll');

    let viewMode = 'all'; // 'all' | 'store'
    let storeFilter = 'Alle';

    function render(){
      ensureMonth();
      renderStorePills();
      const items = getVisibleItems();
      listEl.innerHTML = '';

      if(items.length === 0){
        listEl.innerHTML = `<div class="empty">Nog niets hier. Voeg items toe hieronder ðŸ‘‡</div>`;
      }else{
        items.forEach(it => listEl.appendChild(renderItem(it)));
      }

      // Totals
      const totalAll = sum(state.items.map(totalOfItem));
      const totalVisible = sum(items.map(totalOfItem));

      totalAllEl.textContent = fmt(totalAll);
      totalVisibleEl.textContent = fmt(totalVisible);
      const monthTotalEl = document.getElementById('monthTotalEl');
      if (monthTotalEl) monthTotalEl.textContent = fmt(state.monthTotal || 0);
    }

    function renderItem(it){
      const row = document.createElement('div');
      row.className = 'item';
      row.innerHTML = `
        <input class="ck" type="checkbox" ${it.checked ? 'checked':''} aria-label="Afgevinkt" />
        <div>
          <div class="name">${escapeHtml(it.name)} ${it.recurring ? '<span class="tag">â†»</span>':''}</div>
          <div class="meta">${escapeHtml(it.store)} â€¢ ${it.qty} Ã— ${fmt(it.unitPrice)} = <b>${fmt(totalOfItem(it))}</b></div>
        </div>
        <div class="row-actions">
          <button class="iconbtn pressable" title="Bewerken" aria-label="Bewerken"><span class="icon">âœŽ</span></button>
          <button class="iconbtn danger pressable" title="Verwijderen" aria-label="Verwijderen"><span class="icon">ðŸ—‘</span></button>
        </div>
      `;
      const [ck, , actions] = row.children;
      ck.addEventListener('change', ()=>{ it.checked = ck.checked; save(); render(); });

      const editBtn = actions.children[0];
      const delBtn = actions.children[1];
      editBtn.addEventListener('click', ()=> editItem(it));
      delBtn.addEventListener('click', ()=> removeItem(it.id));
      return row;
    }

    function renderStorePills(){
      // Show only in 'store' view
      storeFilterEl.style.display = (viewMode === 'store') ? '' : 'none';
      if(viewMode !== 'store') return;
      const stores = ['Alle', ...unique((state.settings.stores||[]).slice()).sort()];
      storeFilterEl.innerHTML = '';
      stores.forEach(s=>{
        const el = document.createElement('button');
        el.className = 'store-pill' + (storeFilter===s ? ' active':'' );
        el.textContent = s;
        el.addEventListener('click', ()=>{ storeFilter=s; render(); });
        storeFilterEl.appendChild(el);
      });
    }
    function renderStoreOptions(){
      const sel = document.getElementById('store');
      if(!sel) return;
      const prev = sel.value; // try to keep current selection
      sel.innerHTML = '';
      const stores = (state.settings.stores && state.settings.stores.length) ? state.settings.stores : DEFAULT_STORES;
      stores.forEach(name=>{
        const opt = document.createElement('option');
        opt.value = name; opt.textContent = name;
        sel.appendChild(opt);
      });
      // restore selection or default to first
      if(prev && stores.includes(prev)){
        sel.value = prev;
      }else{
        sel.value = stores[0] || 'Algemeen';
      }
    }

    function renderStoreManager(){
      const list = document.getElementById('storeList');
      if(!list) return;
      list.innerHTML = '';
      const stores = (state.settings.stores||[]).slice();
      stores.forEach(name=>{
        const btn = document.createElement('button');
        btn.className = 'store-pill';
        btn.style.display = 'inline-flex';
        btn.style.alignItems = 'center';
        btn.style.gap = '8px';
        btn.textContent = name;
        const del = document.createElement('span');
        del.className = 'iconbtn danger';
        del.style.width = '28px';
        del.style.height = '28px';
        del.style.marginLeft = '6px';
        del.style.fontSize = '12px';
        del.style.display = 'inline-grid';
        del.style.placeItems = 'center';
        del.style.cursor = 'pointer';
        del.textContent = 'ðŸ—‘';
        if(name === 'Algemeen'){
          del.style.opacity = '0.4';
          del.style.pointerEvents = 'none';
          del.title = 'Algemeen kan niet verwijderd worden';
        }
        del.addEventListener('click', ()=> removeStore(name));
        btn.appendChild(del);
        list.appendChild(btn);
      });
    }

    function addStore(name){
      const n = String(name||'').trim();
      if(!n) return alert('Geef een winkelnaam in.');
      const exists = (state.settings.stores||[]).some(s=>s.toLowerCase()===n.toLowerCase());
      if(exists) return alert('Deze winkel bestaat al.');
      state.settings.stores = [...(state.settings.stores||[]), n];
      save();
      renderStoreOptions();
      renderStoreManager();
      renderStorePills();
    }

    function removeStore(name){
      if(name==='Algemeen') return; // protect
      const affected = state.items.filter(i=>i.store===name).length;
      if(!confirm(`Winkel "${name}" verwijderen${affected?`? (${affected} item(s) worden verplaatst naar Algemeen)`:''}`)) return;
      state.settings.stores = (state.settings.stores||[]).filter(s=>s!==name);
      // Reassign items with this store to 'Algemeen'
      state.items.forEach(i=>{ if(i.store===name) i.store = 'Algemeen'; });
      save();
      render();
      renderStoreOptions();
      renderStoreManager();
      renderStorePills();
    }

    // -------- Logic
    function totalOfItem(it){
      const q = num(it.qty), p = num(it.unitPrice);
      return round2(q * p);
    }
    function getVisibleItems(){
      if(viewMode==='all') return [...state.items];
      // store view
      if(storeFilter==='Alle') return [...state.items].sort(byStoreName);
      return state.items.filter(i=>i.store===storeFilter).sort(byStoreName);
    }
    const byStoreName = (a,b) => a.store.localeCompare(b.store) || a.name.localeCompare(b.name);

    // -------- CRUD
    function addItem(data){
      state.items.push({
        id: uid(),
        name: data.name.trim(),
        qty: num(data.qty),
        unitPrice: num(data.unitPrice),
        store: data.store || 'Algemeen',
        recurring: !!data.recurring,
        checked: false,
        createdAt: Date.now()
      });
      save(); render();
    }
    function editItem(it){
      const name = prompt('Naam', it.name);
      if(name===null) return;
      const qty = prompt('Aantal', String(it.qty));
      if(qty===null) return;
      const up = prompt('Prijs/stuk (â‚¬)', String(it.unitPrice));
      if(up===null) return;
      const store = prompt('Winkel', it.store) ?? it.store;
      const rec = confirm('Terugkeerbaar maken? (OK = ja, Annuleren = nee)');
      it.name = name.trim();
      it.qty = num(qty);
      it.unitPrice = num(up);
      it.store = (store||'Algemeen').trim();
      it.recurring = rec;
      save(); render();
    }
    function removeItem(id){
      state.items = state.items.filter(i=>i.id!==id);
      save(); render();
    }

    // -------- Settings
    const settingsDlg = $('#settingsDlg');
    $('#openSettings').addEventListener('click', ()=>{
      $('#currency').value = state.settings.currency || 'EUR';
      $('#themeSel').value = state.settings.theme || 'system';
      $('#fontScale').value = String(state.settings.fontScale || 1);
      $('#togglePriceField').checked = state.settings.showPrice !== false;
      renderStoreManager();
      const bodyEl = settingsDlg.querySelector('.dlg-body');
      bodyEl.removeEventListener('scroll', updateScrollCue); // avoid dupes
      bodyEl.addEventListener('scroll', updateScrollCue);
      // defer to allow layout to settle
      setTimeout(updateScrollCue, 0);
      const onResize = ()=> updateScrollCue();
      window.addEventListener('resize', onResize, { once: true });
      settingsDlg.showModal();
    });
    $('#closeSettings').addEventListener('click', ()=> settingsDlg.close());
    $('#saveSettings').addEventListener('click', ()=>{
      state.settings.currency = $('#currency').value;
      state.settings.theme = $('#themeSel').value;
      state.settings.fontScale = Number($('#fontScale').value);
      state.settings.showPrice = $('#togglePriceField').checked;
      applyPriceVisibility();
      applyTheme();
      applyFontScale();
      renderStoreOptions();
      save(); render(); settingsDlg.close();
    });
    $('#resetAll').addEventListener('click', ()=>{
      if(!confirm('Alles resetten? (items + instellingen)')) return;
      state = defaultState(); save(); render(); settingsDlg.close();
    });

    // Permanently delete all app data (localStorage) and reload
    $('#purgeAllBtn').addEventListener('click', ()=>{
      if(!confirm('ALLE data verwijderen? Dit wist je volledige lijst + instellingen uit localStorage.')) return;
      try{
        localStorage.removeItem(LS_KEY);
        // Optional: clear everything for this origin if nothing else is used
        // localStorage.clear();
      }catch(_){}
      // Reset in-memory state and reload for a clean start
      state = defaultState();
      try{ settingsDlg.close(); }catch(_){ }
      location.reload();
    });

    // -------- Buttons (Clear month / Export)
    $('#clearMonthBtn').addEventListener('click', ()=>{
      if(!confirm('Deze maand wissen? Niet-terugkeerbare items verdwijnen. Terugkeerbare blijven staan.')) return;
      state.items = state.items.filter(i=>i.recurring);
      state.monthTotal = 0;
      state.month = monthKey(); // blijft huidige
      save(); render();
      alert('Maand gewist. Terugkeerbare items bleven staan.');
    });
    // -------- Weekly rollover
    $('#nextWeekBtn').addEventListener('click', ()=>{
      if(!confirm('Deze week afsluiten en optellen bij "Totaal deze maand"?')) return;
      const weekTotal = sum(state.items.map(totalOfItem));
      state.monthTotal = round2((state.monthTotal || 0) + weekTotal);
      // Clear niet-terugkeerbare items voor nieuwe week
      state.items = state.items.filter(i=>i.recurring);
      save();
      render();
      alert(`+${fmt(weekTotal)} toegevoegd aan Totaal deze maand.`);
    });
    // -------- Monthly rollover
    $('#nextMonthBtn').addEventListener('click', ()=>{
      if(!confirm('Deze maand afsluiten en alles resetten (behalve terugkeerbare items)?')) return;
      state.items = state.items.filter(i=>i.recurring);
      state.monthTotal = 0;
      state.month = monthKey();
      save();
      render();
      alert('Nieuwe maand gestart. Totaal deze maand is gereset.');
    });

    // -------- View switch
    $('#viewSeg').addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      [...$('#viewSeg').children].forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      viewMode = btn.dataset.view;
      render();
    });

    // -------- Add form
    $('#addForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const name = $('#name').value;
      const qty = $('#qty').value;
      const store = $('#store').value;
      const recurring = $('#recurring').checked;
      const priceVisible = state.settings.showPrice !== false;
      const priceVal = priceVisible ? $('#price').value : 0;
      if(!name || num(qty)<=0) return;
      if(!state.settings.stores.some(s=>s===store)){
        state.settings.stores.push(store);
      }
      addItem({name, qty, unitPrice:priceVal, store, recurring});
      e.target.reset();
      $('#qty').value = 1;
    });
    // -------- Store manager add/remove listeners
    const addStoreBtn = document.getElementById('addStoreBtn');
    const newStoreName = document.getElementById('newStoreName');
    if(addStoreBtn){
      addStoreBtn.addEventListener('click', ()=>{
        addStore(newStoreName.value);
        newStoreName.value = '';
        newStoreName.focus();
      });
    }
    if(newStoreName){
      newStoreName.addEventListener('keydown', (e)=>{
        if(e.key==='Enter'){
          e.preventDefault();
          addStore(newStoreName.value);
          newStoreName.value='';
        }
      });
    }

    // -------- Helpers
    function num(x){ return Math.max(0, Number(String(x).replace(',','.')) || 0); }
    function round2(n){ return Math.round((n+Number.EPSILON)*100)/100; }
    function sum(arr){ return round2(arr.reduce((a,b)=>a+b,0)); }
    function unique(arr){ return [...new Set(arr.filter(Boolean))]; }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // -------- Init
    (function init(){
      // Month tag
      $('#monthTag').textContent = `Maand: ${state.month}`;
      // Default currency if missing
      state.settings.currency = state.settings.currency || 'EUR';
      applyTheme();
      applyFontScale();
      applyPriceVisibility();
      enablePressEffects('.pressable');
      try{ settingsDlg.close(); }catch(_){}
      renderStoreOptions();
      render();
    })();

    // -------- Store reset to defaults
    const resetStoresBtn = document.getElementById('resetStoresBtn');
    if(resetStoresBtn){
      resetStoresBtn.addEventListener('click', ()=>{
        if(!confirm('Standaard winkellijst herstellen? (je huidige aangepaste lijst wordt vervangen)')) return;
        state.settings.stores = DEFAULT_STORES.slice();
        // Reassign any items with unknown stores back to 'Algemeen'
        const known = new Set(state.settings.stores);
        state.items.forEach(i=>{ if(!known.has(i.store)) i.store = 'Algemeen'; });
        save();
        render();
        renderStoreOptions();
        renderStoreManager();
        renderStorePills();
      });
    }
  </script>
</body>
</html>
    